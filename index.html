<!doctype html>
<html>
    <head>
        <title>Simple collision detection</title>
    </head>
    <body>
        <canvas id="canvas" width="1024" height="768" />
        <script src="BoundingBox.js"></script>
        <script src="SparseGrid.js"></script>
        <script src="Actor.js"></script>
        <script src="Game.js"></script>
        <script>
            (function() {
                var keys = {left: false, right: false, up: false, space: false};
                function onKey(pressed, event) {
                    if(event.keyCode == 37) keys.left = pressed;
                    else if(event.keyCode == 39) keys.right = pressed;
                    else if(event.keyCode == 38) { 
                        if(pressed && !keys.up) player.velocityY = -300; 
                        keys.up = pressed;
                    }
                    else if(event.keyCode == 32) { 
                        if(pressed && !keys.space) for(i = 0; i < 100; i++) spawnParticle(player.boundingBox.x, player.boundingBox.y);
                        keys.space = pressed;
                    }
                    else return;
                    event.preventDefault();
                }
                document.onkeydown = onKey.bind(null, true);
                document.onkeyup = onKey.bind(null, false);
                
                function spawnParticle(x, y) {
                    var angle = Math.random() * Math.PI * 2;
                    var velocity = 100 + 100 * Math.random();
                    var velocityX = Math.cos(angle) * velocity;
                    var velocityY = Math.sin(angle) * velocity - 100;
                    var actor = new Actor(new BoundingBox(x, y, 5, 5), velocityX, velocityY, false);
                    actor.onCollision = Actor.bounceOnCollision;
                    game.insert(actor);
                    console.log(angle);
                }
                
                var randomActors = [];
                for(var i = 0; i < 10000; i++) {
                    var x = Math.random() * 10000;
                    var y = Math.random() * 10000;
                    var w = Math.random() * 200 + 10;
                    var h = Math.random() * 15 + 5;
                    if(Math.random() < 0.5) {
                        var t = w;
                        w = h;
                        h = t;
                    }
                    randomActors.push(new Actor(new BoundingBox(x, y, w, h), 0, 0, true));
                }
                
                var canvasElement = document.getElementById('canvas');
                var context = canvasElement.getContext('2d');
                var player = new Actor(new BoundingBox(120, 100, 20, 30), 0, 0, false);
                var actors = randomActors.concat([
                    player
                ]);
                var game = new Game(actors);
                game.loop(context, function(game, deltaTime) {
                    if(keys.left) player.velocityX = -200;
                    else if(keys.right) player.velocityX = 200;
                    else player.velocityX = 0;
                    for(var i = 0; i < game.actors.length; i++) {
                        var actor = game.actors[i];
                        if(i < 1000 || !actor.solid) {
                            if(actor.boundingBox.y < 2000) actor.velocityY += 800 * deltaTime;
                            else actor.velocityY = Math.min(0, actor.velocityY);
                        }
                    }
                });
            })();
        </script>
    </body>
</html>
